<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Configuration.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">mybatis-scala-core</a> &gt; <a href="index.source.html" class="el_package">org.mybatis.scala.config</a> &gt; <span class="el_source">Configuration.scala</span></div><h1>Configuration.scala</h1><pre class="source lang-java linenums">/*
 *    Copyright 2011-2015 the original author or authors.
 *
 *    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 *    you may not use this file except in compliance with the License.
 *    You may obtain a copy of the License at
 *
 *       https://www.apache.org/licenses/LICENSE-2.0
 *
 *    Unless required by applicable law or agreed to in writing, software
 *    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *    See the License for the specific language governing permissions and
 *    limitations under the License.
 */
package org.mybatis.scala.config

import org.apache.ibatis.session.{ Configuration =&gt; MBConfig, SqlSessionFactoryBuilder }
import org.apache.ibatis.builder.xml.XMLConfigBuilder
import java.io.Reader
import org.apache.ibatis.io.Resources
import org.mybatis.scala.session.SessionManager
import java.util.Properties
import org.mybatis.scala.mapping.Statement
import org.mybatis.scala.mapping.T
import org.mybatis.scala.cache._
import org.apache.ibatis.`type`.TypeHandler

/**
 * Mybatis Configuration
 * @constructor Creates a new Configuration with a wrapped myBatis Configuration.
 * @param configuration A myBatis Configuration instance.
 */
<span class="nc" id="L34">sealed class Configuration(private val configuration: MBConfig) {</span>

<span class="nc bnc" id="L36" title="All 6 branches missed.">  if (configuration.getObjectFactory().getClass == classOf[org.apache.ibatis.reflection.factory.DefaultObjectFactory]) {</span>
<span class="nc" id="L37">    configuration.setObjectFactory(new DefaultObjectFactory())</span>
  }

<span class="nc bnc" id="L40" title="All 6 branches missed.">  if (configuration.getObjectWrapperFactory.getClass == classOf[org.apache.ibatis.reflection.wrapper.DefaultObjectWrapperFactory]) {</span>
<span class="nc" id="L41">    configuration.setObjectWrapperFactory(new DefaultObjectWrapperFactory())</span>
  }

<span class="nc" id="L44">  registerCommonOptionTypeHandlers</span>

<span class="nc bnc" id="L46" title="All 4 branches missed.">  lazy val defaultSpace = new ConfigurationSpace(configuration, &quot;_DEFAULT_&quot;)</span>

  /**
   * Creates a new space of mapped statements.
   * @param name A Speca name (a.k.a. namespace)
   * @param f A configuration block.
   */
  def addSpace(name: String)(f: (ConfigurationSpace =&gt; Unit)): this.type = {
<span class="nc" id="L54">    val space = new ConfigurationSpace(configuration, name)</span>
<span class="nc" id="L55">    f(space)</span>
<span class="nc" id="L56">    this</span>
  }

  /** Adds a statement to the default space */
<span class="nc" id="L60">  def +=(s: Statement) = defaultSpace += s</span>

  /** Adds a sequence of statements to the default space */
<span class="nc" id="L63">  def ++=(ss: Seq[Statement]) = defaultSpace ++= ss</span>

  /** Adds a mapper to the space */
<span class="nc" id="L66">  def ++=(mapper: { def bind: Seq[Statement] }) = defaultSpace ++= mapper</span>

  /**
   * Adds cache support to this space.
   * @param impl Cache implementation class
   * @param eviction cache eviction policy (LRU,FIFO,WEAK,SOFT)
   * @param flushInterval any positive integer in milliseconds.
   *        The default is not set, thus no flush interval is used and the cache is only flushed by calls to statements.
   * @param size max number of objects that can live in the cache. Default is 1024
   * @param readWrite A read-only cache will return the same instance of the cached object to all callers.
   *        Thus such objects should not be modified.  This offers a significant performance advantage though.
   *        A read-write cache will return a copy (via serialization) of the cached object,
   *        this is slower, but safer, and thus the default is true.
   * @param props implementation specific properties.
   */
  def cache(
<span class="nc" id="L82">    impl: T[_ &lt;: Cache] = DefaultCache,</span>
<span class="nc" id="L83">    eviction: T[_ &lt;: Cache] = Eviction.LRU,</span>
<span class="nc" id="L84">    flushInterval: Long = -1,</span>
<span class="nc" id="L85">    size: Int = -1,</span>
<span class="nc" id="L86">    readWrite: Boolean = true,</span>
<span class="nc" id="L87">    blocking : Boolean = false,</span>
<span class="nc" id="L88">    props: Properties = null) =</span>
<span class="nc" id="L89">    defaultSpace.cache(impl, eviction, flushInterval, size, readWrite, blocking, props)</span>

  /** Reference to an external Cache */
<span class="nc" id="L92">  def cacheRef(that: ConfigurationSpace) = defaultSpace.cacheRef(that)</span>

  /** Builds a Session Manager */
  def createPersistenceContext = {
<span class="nc" id="L96">    val builder = new SqlSessionFactoryBuilder</span>
<span class="nc" id="L97">    new SessionManager(builder.build(configuration))</span>
  }

  private def registerOptionTypeHandler[T &lt;: Option[_]](h: TypeHandler[T], jdbcTypes: Seq[org.apache.ibatis.`type`.JdbcType]) = {
    import org.mybatis.scala.mapping.OptionTypeHandler
<span class="nc" id="L102">    val registry = configuration.getTypeHandlerRegistry</span>
<span class="nc" id="L103">    val cls = classOf[Option[_]]</span>
<span class="nc" id="L104">    for (jdbcType &lt;- jdbcTypes) {</span>
<span class="nc" id="L105">      registry.register(cls, jdbcType, h)</span>
    }
  }

  private def registerCommonOptionTypeHandlers = {
    import org.mybatis.scala.mapping.OptionTypeHandler
    import org.mybatis.scala.mapping.TypeHandlers._
    import org.apache.ibatis.`type`._
    import org.apache.ibatis.`type`.JdbcType._
<span class="nc" id="L114">    registerOptionTypeHandler(new OptBooleanTypeHandler(), Seq(BOOLEAN, BIT))</span>
<span class="nc" id="L115">    registerOptionTypeHandler(new OptByteTypeHandler(), Seq(TINYINT))</span>
<span class="nc" id="L116">    registerOptionTypeHandler(new OptShortTypeHandler(), Seq(SMALLINT))</span>
<span class="nc" id="L117">    registerOptionTypeHandler(new OptIntegerTypeHandler(), Seq(INTEGER))</span>
<span class="nc" id="L118">    registerOptionTypeHandler(new OptFloatTypeHandler(), Seq(FLOAT))</span>
<span class="nc" id="L119">    registerOptionTypeHandler(new OptDoubleTypeHandler(), Seq(DOUBLE))</span>
<span class="nc" id="L120">    registerOptionTypeHandler(new OptLongTypeHandler(), Seq(BIGINT))</span>
<span class="nc" id="L121">    registerOptionTypeHandler(new OptStringTypeHandler(), Seq(VARCHAR, CHAR))</span>
<span class="nc" id="L122">    registerOptionTypeHandler(new OptClobTypeHandler(), Seq(CLOB, LONGVARCHAR))</span>
<span class="nc" id="L123">    registerOptionTypeHandler(new OptNStringTypeHandler(), Seq(NVARCHAR, NCHAR))</span>
<span class="nc" id="L124">    registerOptionTypeHandler(new OptNClobTypeHandler(), Seq(NCLOB))</span>
<span class="nc" id="L125">    registerOptionTypeHandler(new OptBigDecimalTypeHandler(), Seq(REAL, DECIMAL, NUMERIC))</span>
<span class="nc" id="L126">    registerOptionTypeHandler(new OptBlobTypeHandler(), Seq(BLOB, LONGVARBINARY))</span>
<span class="nc" id="L127">    registerOptionTypeHandler(new OptDateTypeHandler(), Seq(DATE))</span>
<span class="nc" id="L128">    registerOptionTypeHandler(new OptTimeTypeHandler(), Seq(TIME))</span>
<span class="nc" id="L129">    registerOptionTypeHandler(new OptTimestampTypeHandler(), Seq(TIMESTAMP))</span>
<span class="nc" id="L130">    registerOptionTypeHandler(new OptionTypeHandler(new UnknownTypeHandler(configuration.getTypeHandlerRegistry)), Seq(OTHER))</span>
  }

}

/** A factory of [[org.mybatis.scala.config.Configuration]] instances. */
<span class="nc" id="L136">object Configuration {</span>

  /**
   * Creates a Configuration built from a reader.
   * @param reader Reader over a myBatis main configuration XML
   */
  def apply(reader: Reader): Configuration = {
<span class="nc" id="L143">    val builder = new XMLConfigBuilder(reader)</span>
<span class="nc" id="L144">    new Configuration(builder.parse)</span>
  }

  /**
   * Creates a Configuration built from a reader.
   * @param reader Reader over a myBatis main configuration XML
   * @param env Environment name
   */
  def apply(reader: Reader, env: String): Configuration = {
<span class="nc" id="L153">    val builder = new XMLConfigBuilder(reader, env)</span>
<span class="nc" id="L154">    new Configuration(builder.parse)</span>
  }

  /**
   * Creates a Configuration built from a reader.
   * @param reader Reader over a myBatis main configuration XML
   * @param env Environment name
   * @param properties Properties
   */
  def apply(reader: Reader, env: String, properties: Properties): Configuration = {
<span class="nc" id="L164">    val builder = new XMLConfigBuilder(reader, env, properties)</span>
<span class="nc" id="L165">    new Configuration(builder.parse)</span>
  }

  /**
   * Creates a Configuration built from a classpath resource.
   * @param path Classpath resource with main configuration XML
   */
  def apply(path: String): Configuration = {
<span class="nc" id="L173">    apply(Resources.getResourceAsReader(path))</span>
  }

  /**
   * Creates a Configuration built from a classpath resource.
   * @param path Classpath resource with main configuration XML
   * @param env Environment name
   */
  def apply(path: String, env: String): Configuration = {
<span class="nc" id="L182">    apply(Resources.getResourceAsReader(path), env)</span>
  }

  /**
   * Creates a Configuration built from a classpath resource.
   * @param path Classpath resource with main configuration XML
   * @param env Environment name
   * @param properties Properties
   */
  def apply(path: String, env: String, properties: Properties): Configuration = {
<span class="nc" id="L192">    apply(Resources.getResourceAsReader(path), env, properties)</span>
  }

  /**
   * Creates a Configuration built from an environment
   * @param env Environment
   */
  def apply(env: Environment): Configuration = {
<span class="nc" id="L200">    new Configuration(new MBConfig(env.unwrap))</span>
  }

  /**
   * Creates a Configuration built from a custom builder
   * @param builder Builder =&gt; Unit
   */
<span class="nc" id="L207">  def apply(builder: Builder): Configuration = builder.build()</span>

  /** Configuration builder */
<span class="nc" id="L210">  class Builder {</span>

    import org.mybatis.scala.mapping.JdbcType
    import org.apache.ibatis.plugin.Interceptor
    import scala.collection.mutable.ArrayBuffer
    import org.mybatis.scala.session.ExecutorType
    import scala.jdk.CollectionConverters._
    import org.apache.ibatis.mapping.Environment

    /** Reference to self. Support for operational notation. */
<span class="nc" id="L220">    protected val &gt;&gt; = this</span>

    /** Mutable hidden state, discarded after construction */
<span class="nc" id="L223">    private val pre = new ArrayBuffer[ConfigElem[MBConfig]]()</span>

    /** Mutable hidden state, discarded after construction */
<span class="nc" id="L226">    private val pos = new ArrayBuffer[ConfigElem[Configuration]]()</span>

    /** Configuration Element */
<span class="nc bnc" id="L229" title="All 2 branches missed.">    private abstract class ConfigElem[T] {</span>
      val index: Int
      def set(config: T): Unit
    }

    /** Ordered deferred setter */
<span class="nc" id="L235">    private def set[A](i: Int, e: ArrayBuffer[ConfigElem[A]])(f: A =&gt; Unit): Unit = {</span>
<span class="nc" id="L236">      e += new ConfigElem[A] {</span>
<span class="nc" id="L237">        val index = i</span>
<span class="nc" id="L238">        def set(c: A) = f(c)</span>
      }
    }

    /** Builds the configuration object */
    private[Configuration] def build(): Configuration = {
<span class="nc" id="L244">      val preConfig = new MBConfig()</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">      pre.sortWith((a, b) =&gt; a.index &lt; b.index).foreach(_.set(preConfig))</span>
<span class="nc" id="L246">      val config = new Configuration(preConfig)</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">      pos.sortWith((a, b) =&gt; a.index &lt; b.index).foreach(_.set(config))</span>
<span class="nc" id="L248">      config</span>
    }

    // Pre ====================================================================
    
    def properties(props: (String, String)*) =
<span class="nc" id="L254">      set(0, pre) { _.getVariables.asScala ++= Map(props: _*) }</span>

    def properties(props: Properties) =
<span class="nc" id="L257">      set(1, pre) { _.getVariables.asScala ++= props.asScala }</span>

    def properties(resource: String) =
<span class="nc" id="L260">      set(2, pre) { _.getVariables.asScala ++= Resources.getResourceAsProperties(resource).asScala }</span>

    def propertiesFromUrl(url: String) =
<span class="nc" id="L263">      set(3, pre) { _.getVariables.asScala ++= Resources.getUrlAsProperties(url).asScala }</span>

    def plugin(plugin: Interceptor) =
<span class="nc" id="L266">      set(4, pre) { _.addInterceptor(plugin) }</span>

    def objectFactory(factory: ObjectFactory) =
<span class="nc" id="L269">      set(5, pre) { _.setObjectFactory(factory) }</span>

    def objectWrapperFactory(factory: ObjectWrapperFactory) =
<span class="nc" id="L272">      set(6, pre) { _.setObjectWrapperFactory(factory) }</span>

    // Settings ===============

    def autoMappingBehavior(behavior: AutoMappingBehavior) =
<span class="nc" id="L277">      set(8, pre) { _.setAutoMappingBehavior(behavior.unwrap) }</span>

    def cacheSupport(enabled: Boolean) =
<span class="nc" id="L280">      set(9, pre) { _.setCacheEnabled(enabled) }</span>

    def lazyLoadingSupport(enabled: Boolean) =
<span class="nc" id="L283">      set(10, pre) { _.setLazyLoadingEnabled(enabled) }</span>

    def aggressiveLazyLoading(enabled: Boolean) = 
<span class="nc" id="L286">      set(11, pre) { _.setAggressiveLazyLoading(enabled) }</span>
    
    def multipleResultSetsSupport(enabled: Boolean) = 
<span class="nc" id="L289">      set(12, pre) { _.setMultipleResultSetsEnabled(enabled) }</span>
    
    def useColumnLabel(enabled: Boolean) = 
<span class="nc" id="L292">      set(13, pre) { _.setUseColumnLabel(enabled) }</span>
    
    def useGeneratedKeys(enabled: Boolean) = 
<span class="nc" id="L295">      set(14, pre) { _.setUseGeneratedKeys(enabled) }</span>
    
    def defaultExecutorType(executorType: ExecutorType) = 
<span class="nc" id="L298">      set(15, pre) { _.setDefaultExecutorType(executorType.unwrap) }</span>
    
    def defaultStatementTimeout(timeout: Int) = 
<span class="nc" id="L301">      set(16, pre) { _.setDefaultStatementTimeout(timeout) }</span>
    
    def mapUnderscoreToCamelCase(enabled: Boolean) = 
<span class="nc" id="L304">      set(17, pre) { _.setMapUnderscoreToCamelCase(enabled) }</span>
    
    def safeRowBoundsSupport(enabled: Boolean) = 
<span class="nc" id="L307">      set(18, pre) { _.setSafeRowBoundsEnabled(enabled) }</span>
    
    def localCacheScope(localCacheScope: LocalCacheScope) = 
<span class="nc" id="L310">      set(19, pre) { _.setLocalCacheScope(localCacheScope.unwrap) }</span>
    
    def jdbcTypeForNull(jdbcType: JdbcType) = 
<span class="nc" id="L313">      set(20, pre) { _.setJdbcTypeForNull(jdbcType.unwrap) }</span>
    
    def lazyLoadTriggerMethods(names: Set[String]) = 
<span class="nc" id="L316">      set(21, pre) { _.setLazyLoadTriggerMethods(names.asJava) }</span>
    
    def environment(id: String, transactionFactory: TransactionFactory, dataSource: javax.sql.DataSource) =
<span class="nc" id="L319">      set(24, pre) { _.setEnvironment(new Environment(id, transactionFactory, dataSource)) }</span>

    def databaseIdProvider(provider: DatabaseIdProvider) =
<span class="nc" id="L322">      set(25, pre) { c =&gt; c.setDatabaseId(provider.getDatabaseId(c.getEnvironment.getDataSource)) }</span>

    def typeHandler(jdbcType: JdbcType, handler: (T[_], TypeHandler[_])) =
<span class="nc" id="L325">      set(26, pre) { _.getTypeHandlerRegistry.register(handler._1.raw, jdbcType.unwrap, handler._2) }</span>

    def typeHandler(handler: (T[_], TypeHandler[_])) = 
<span class="nc" id="L328">      set(26, pre) { _.getTypeHandlerRegistry.register(handler._1.raw, handler._2) }</span>
    
    def typeHandler(handler: TypeHandler[_]) = 
<span class="nc" id="L331">      set(26, pre) { _.getTypeHandlerRegistry.register(handler) }</span>

    // Pos ===========================================================

    def namespace(name: String)(f: (ConfigurationSpace =&gt; Unit)) =
<span class="nc" id="L336">      set(0, pos) { c =&gt; f(new ConfigurationSpace(c.configuration, name)) }</span>

    def statements(s: Statement*) = 
<span class="nc" id="L339">      set(1, pos) { _ ++= s }</span>
    
    def mappers(mappers: { def bind: Seq[Statement] }*) = 
<span class="nc" id="L342">      set(1, pos) { c =&gt; mappers.foreach(c ++= _) }</span>
    
    def cacheRef(that: ConfigurationSpace) = 
<span class="nc" id="L345">      set(2, pos) { _.cacheRef(that) }</span>
    
    def cache(
<span class="nc" id="L348">      impl: T[_ &lt;: Cache] = DefaultCache,</span>
<span class="nc" id="L349">      eviction: T[_ &lt;: Cache] = Eviction.LRU,</span>
<span class="nc" id="L350">      flushInterval: Long = -1,</span>
<span class="nc" id="L351">      size: Int = -1,</span>
<span class="nc" id="L352">      readWrite: Boolean = true,</span>
<span class="nc" id="L353">      blocking : Boolean = false,</span>
<span class="nc" id="L354">      props: Properties = null) = </span>
<span class="nc" id="L355">        set(2, pos) { _.cache(impl, eviction, flushInterval, size, readWrite, blocking, props) }</span>

    // PENDING FOR mybatis 3.1.1+ ==================================================
    
    // TODO (3.1.1) def proxyFactory(factory: ProxyFactory) = set( 7, pre) { _.setProxyFactory(factory) }
    // TODO (3.1.1) def safeResultHandlerSupport(enabled : Boolean) = set(22, pre) { _.setSafeResultHandlerEnabled(enabled) }
    // TODO (3.1.1) def defaultScriptingLanguage(driver : T[_]) = set(23, pre) { _.setDefaultScriptingLanguage(driver) }

  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>